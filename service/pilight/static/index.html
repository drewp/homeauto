<!doctype html>
<html>
  <head>
    <title>pilight</title>
    <meta charset="utf-8" />
    <script src="//bigasterisk.com/lib/jquery-2.0.3.js"></script>
    <script src="//bigasterisk.com/lib/platform/0.2.3/platform.js"></script>
    <link rel="import" href="static/input-rgb/input-rgb.html">
    <style>
      input-rgb {
       border: 1px solid gray;
       width: 300px;
     }
    </style>
  </head>
  <body>

    <polymer-element name="led-output" attributes="url color">
    <!-- calls PUT <url> with color string as the body, but also
         avoids sending many repeated calls to url while the first one
         is still in progress -->
      <template>
        {{status}}
      </template>
      <script>Polymer('led-output', {
          created: function() {
              this.pending = {}; // url: data
              this.inflight = false;
          },
          colorChanged: function() {
              this.pending["led"] = this.color;
              this.sendMore();
          },
          sendMore: function() {
              if (this.inflight) {
                  return;
              }
              var urls = Object.keys(this.pending);
              if (!urls.length) {
                  return;
              }
              var url = urls.pop();
              var data = this.pending[url];
              delete this.pending[url];

              this.status = "Sending...";
              this.inflight = true;
              $.ajax({
                  type: "PUT",
                  url: url,
                  data: data,
                  success: function() {
                      this.status = "";
                  }.bind(this),
                  error: function() {
                      this.status = "Send failed";
                  }.bind(this),
                  complete: function() {
                      this.inflight = false;
                      this.sendMore();
                  }.bind(this)
              });
        }
      });
      </script>

    </polymer-element>
      
    <polymer-element name="pilight-page" noscript>
      <template>
        LED0 color:
        <input-rgb editable="true" hex="{{c1}}"></input-rgb>
        <led-output which="led" color="{{c1}}"></led-output>
      </template>
    </polymer-element>

    <pilight-page></pilight-page>


    <div>
      DHT: <span id="dht"></span>
      <div id="temperature" style="background: #cff"></div>
      <div id="humidity" style="background: #fef"></div>
    </div>
    <script>
    $(function() {
        function update() {
            $.getJSON("dht", function(result) {
                result['tempF'] = 1.8 * result['temperature'] + 32;
                result['time'] = new Date().toLocaleString();
                $("#dht").text(JSON.stringify(result));
                $("#temperature")
                    .text(result['tempF'] + " deg F")
                    .css('width', result['temperature'] * 10);
                $("#humidity")
                    .text(result['humidity'] + " humidity")
                    .css('width', result['humidity'] * 10);
            });
        }

        function loop() {
            update();
            setTimeout(function() {
                requestAnimationFrame(loop);
            }, 2000);
        }
        loop();
    });
    </script>
  </body>
</html>
